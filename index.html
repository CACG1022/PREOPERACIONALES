<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario Técnico - Preoperacionales</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #e9edf4;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 500px;
      margin: 40px auto;
      background-color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #003366;
      margin-bottom: 25px;
      font-size: 20px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
      color: #333;
    }
    input[type="text"],
    input[type="file"],
    textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 18px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    input[type="submit"] {
      width: 100%;
      background-color: #004080;
      color: white;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    input[type="submit"]:hover {
      background-color: #0059b3;
    }
    .barcode-section {
      margin-top: 25px;
      text-align: center;
    }
    #reader {
      width: 100%;
      max-width: 320px;
      margin: 0 auto 10px auto;
      display: none;
    }
    .scan-btn {
      width: 100%;
      padding: 10px;
      background: #00a650;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background 0.3s;
    }
    .scan-btn:hover {
      background: #007b3c;
    }
    #map { 
      height: 220px; 
      margin-bottom: 16px; 
      border-radius: 8px; 
    }
    .preview-img {
      display: block;
      max-width: 100%;
      max-height: 180px;
      margin: 7px auto 16px auto;
      border-radius: 6px;
      border: 1px solid #bbb;
      box-shadow: 0 1px 5px #ccc;
      background: #f8f8f8;
      object-fit: contain;
    }
    @media (max-width: 600px) {
      .container { margin: 20px 10px; padding: 15px; }
      h2 { font-size: 18px; }
      #reader { max-width: 100vw; }
      .preview-img { max-height: 110px; }
    }
  </style>
  <!-- Librerías externas -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="container">
    <!-- LOGO -->
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="https://static.wixstatic.com/media/ac1ed1_2f7866fceffb4207a501cc64eb2f6deb~mv2.png/v1/crop/x_0,y_212,w_1080,h_612/fill/w_556,h_315,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/PDR2.png" alt="Logo de la empresa" style="max-width: 180px; height: auto;">
    </div>
    <!-- TÍTULO -->
    <h2>Preoperacionales</h2>
    <!-- FORMULARIO -->
    <form action="https://ftth-n8n2.pzveh5.easypanel.host/webhook/preoperacionales" method="POST" enctype="multipart/form-data">
      <label for="nombre_tecnico">Nombre del técnico:</label>
      <input type="text" name="nombre_tecnico" id="nombre_tecnico" required>
      <label for="ciudad">Ciudad:</label>
      <input type="text" name="ciudad" id="ciudad" required>
      <!-- Mapa y coordenadas -->
      <label>Ubicación en mapa:</label>
      <div id="map"></div>
      <label for="latitud">Latitud:</label>
      <input type="text" name="latitud" id="latitud" required readonly>
      <label for="longitud">Longitud:</label>
      <input type="text" name="longitud" id="longitud" required readonly>
      <label for="fechaHora">Fecha y hora actual:</label>
      <input type="text" name="fecha_hora" id="fechaHora" readonly>

      <label for="foto1">Foto 1:</label>
      <input type="file" name="foto1" id="foto1" accept="image/*" capture="environment" required>
      <img id="preview-foto1" class="preview-img" style="display:none;" alt="Previsualización Foto 1">
      
      <label for="foto2">Foto 2:</label>
      <input type="file" name="foto2" id="foto2" accept="image/*" capture="environment">
      <img id="preview-foto2" class="preview-img" style="display:none;" alt="Previsualización Foto 2">

      <label for="foto3">Foto 3:</label>
      <input type="file" name="foto3" id="foto3" accept="image/*" capture="environment">
      <img id="preview-foto3" class="preview-img" style="display:none;" alt="Previsualización Foto 3">

      <label for="observaciones">Observaciones:</label>
      <textarea name="observaciones" id="observaciones" rows="4"></textarea>
      <!-- Sección para escanear código de barras -->
      <div class="barcode-section">
        <label for="barcode">Código escaneado (QR o Barras):</label>
        <input type="text" name="barcode" id="barcode" readonly>
        <div id="reader"></div>
        <button type="button" class="scan-btn" id="scan-barcode-btn">Escanear código de barras o QR</button>
        <div style="font-size:12px;color:#555;margin-top:5px;">Coloca el código bien enfocado y con buena luz. Puedes escanear códigos de barras largos (Code128, EAN-13, etc.) o QR.</div>
      </div>
      <input type="submit" value="Enviar">
    </form>
  </div>
  <script>
    // Fecha y hora actual
    const ahora = new Date();
    const año = ahora.getFullYear();
    const mes = String(ahora.getMonth() + 1).padStart(2, '0');
    const dia = String(ahora.getDate()).padStart(2, '0');
    const hora = String(ahora.getHours()).padStart(2, '0');
    const minutos = String(ahora.getMinutes()).padStart(2, '0');
    const segundos = String(ahora.getSeconds()).padStart(2, '0');
    const fechaFormateada = `${año}-${mes}-${dia} ${hora}:${minutos}:${segundos}`;
    document.getElementById("fechaHora").value = fechaFormateada;

    // Mapa y geolocalización
    let latField = document.getElementById("latitud");
    let lngField = document.getElementById("longitud");
    let map, marker;

    function initMap(lat, lng) {
      map = L.map('map').setView([lat, lng], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 19,
      }).addTo(map);
      marker = L.marker([lat, lng], {draggable: true}).addTo(map);
      marker.on('dragend', function (e) {
        let pos = marker.getLatLng();
        latField.value = pos.lat.toFixed(6);
        lngField.value = pos.lng.toFixed(6);
      });
    }

    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          let lat = position.coords.latitude;
          let lng = position.coords.longitude;
          latField.value = lat.toFixed(6);
          lngField.value = lng.toFixed(6);
          initMap(lat, lng);
        },
        function(error) {
          // Si falla, posición por defecto Bogotá
          let lat = 4.60971, lng = -74.08175;
          latField.value = lat.toFixed(6);
          lngField.value = lng.toFixed(6);
          initMap(lat, lng);
          alert("No se pudo obtener la ubicación: " + error.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    } else {
      // Si no soporta geolocalización
      let lat = 4.60971, lng = -74.08175;
      latField.value = lat.toFixed(6);
      lngField.value = lng.toFixed(6);
      initMap(lat, lng);
      alert("Este navegador no soporta geolocalización.");
    }

    // Escaneo de código de barras/QR
    const btnScan = document.getElementById('scan-barcode-btn');
    let html5QrcodeScanner;
    btnScan.addEventListener('click', function() {
      const readerDiv = document.getElementById('reader');
      readerDiv.style.display = "block";
      if (!html5QrcodeScanner) {
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: 200
          },
          (decodedText, decodedResult) => {
            document.getElementById('barcode').value = decodedText;
            html5QrcodeScanner.stop().then(() => {
              readerDiv.style.display = "none";
            }).catch(err => {
              alert("Error al detener el escaneo: " + err);
            });
          },
          (errorMessage) => {
            // Puedes mostrar errores de escaneo aquí si quieres
          }
        ).catch(err => {
          alert("No se pudo iniciar el escaneo: " + err);
        });
      } else {
        html5QrcodeScanner.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: 200
          },
          (decodedText, decodedResult) => {
            document.getElementById('barcode').value = decodedText;
            html5QrcodeScanner.stop().then(() => {
              readerDiv.style.display = "none";
            }).catch(err => {
              alert("Error al detener el escaneo: " + err);
            });
          }
        );
      }
    });

    // Función para agregar coordenadas a la foto y previsualizar
    function marcarFotoConCoordenadas(inputId, previewId) {
      document.getElementById(inputId).addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (!file) {
          document.getElementById(previewId).style.display = "none";
          return;
        }
        if (!/^image\//.test(file.type)) {
          alert("Por favor selecciona una imagen.");
          document.getElementById(previewId).style.display = "none";
          return;
        }
        const reader = new FileReader();
        reader.onload = function(evt) {
          const img = new Image();
          img.onload = function() {
            // Crear canvas del mismo tamaño que la foto
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);

            // Escribir coordenadas sobre la foto
            const lat = document.getElementById("latitud").value || "Lat: ?";
            const lng = document.getElementById("longitud").value || "Lng: ?";
            ctx.font = Math.max(Math.round(img.width/22), 18) + "px Arial";
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            const text = `Lat: ${lat}   Lng: ${lng}`;
            const rectHeight = parseInt(ctx.font,10) + 20;
            ctx.fillRect(0, canvas.height - rectHeight, canvas.width, rectHeight);
            ctx.fillStyle = "#fff";
            ctx.fillText(text, 15, canvas.height - rectHeight/2 + 7);

            // Mostrar preview
            document.getElementById(previewId).src = canvas.toDataURL(file.type, 0.92);
            document.getElementById(previewId).style.display = "block";

            // Convertir el canvas a un blob para enviar en el formulario
            canvas.toBlob(function(blob) {
              const newFile = new File([blob], file.name, {type: file.type});
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(newFile);
              document.getElementById(inputId).files = dataTransfer.files;
            }, file.type, 0.95);
          };
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
    // Activar para cada foto
    marcarFotoConCoordenadas("foto1", "preview-foto1");
    marcarFotoConCoordenadas("foto2", "preview-foto2");
    marcarFotoConCoordenadas("foto3", "preview-foto3");
  </script>
</body>
</html>




